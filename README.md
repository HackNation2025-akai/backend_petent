# Form Validation Agent (FastAPI + LangChain)

Backend-only template to validate form fields via a LangChain agent using OpenRouter (default `openai/gpt-oss-120b:free`). Exposes REST `POST /api/validate` and logs to Postgres. Includes Docker Compose and helper scripts.

## Requirements
- Python 3.11+
- Docker / Docker Compose
- OpenRouter API key (`OPENROUTER_API_KEY`)

## Local install
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## ENV configuration
Fill `.env` (example):
```
OPENROUTER_API_KEY=your_key
OPENROUTER_MODEL=openai/gpt-oss-120b:free
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
DATABASE_URL=postgresql+asyncpg://app:app@localhost:5432/app
POSTGRES_DB=app
POSTGRES_USER=app
POSTGRES_PASSWORD=app
```

Load variables:
```bash
source scripts/export_env.sh .env
```

## Run
- Local: `uvicorn app.main:app --reload`
- Docker Compose: `docker compose up --build`

## First-time quickstart
1) Create `.env` (use the example below and add your real `OPENROUTER_API_KEY`).
2) Load env vars into the shell (optional but handy): `source scripts/export_env.sh .env`
3) Start everything with Docker (recommended first run): `docker compose up --build`
4) Wait until Postgres is healthy and API is up on `http://localhost:8000`.
5) pgAdmin is available at `http://localhost:5050` (default login from `.env`: `admin@example.com` / `admin`). Add a server pointing to host `db`, user `app`, password `app`.
6) Call the endpoint (example below) or open the autogenerated docs at `http://localhost:8000/docs`.
7) (Optional) Export OpenAPI: `python scripts/export_openapi.py` → `openapi.json`.

## Endpoint
- `POST /api/validate`
  - Body: `{"field_type": "text", "value": "Acme Corp", "context": "Company description"}`
  - Response: `{"status": "success" | "objection", "message": "..." }`

### Supported field types
- `valid1`: expects 11 digits (PESEL-like). LLM decides success/objection based on digit-only + length rule.
- `valid2`: letters only (A-Z + Polish diacritics), must start with uppercase. LLM enforces rule.
- `valid3`: classify job/description into {dentist, hairdresser, other}. If not dentist/hairdresser → objection with hint.
- Legacy/generic types remain: text, email, phone, number, select.

## OpenAPI export
```bash
python scripts/export_openapi.py
```
File `openapi.json` will appear in repo root (gitignored).

## Tests
```bash
./scripts/test.sh          # runs unit + integration
# or scope:
PYTEST_TARGET=tests/unit ./scripts/test.sh
```

## CI
- GitHub Actions workflow `.github/workflows/ci.yml` runs on push/PR: ruff, mypy, pytest (unit+integration) with dummy OpenRouter key.


